## 类型系统

### 通用概念

所谓类型，其实就是对表示信息的值进行细粒度的区分。比如：整数、小数、文本等。粒度再细一点就是：布尔值、符号整型值、无符号整型值，单精度浮点型、双精度浮点型，字符和字符串，甚至还有各种自定义的类型。

在类型系统中，一切皆类型。基于类型定义的一系列组合、运算和转化等方法，可以看作类型的行为。
类型的行为决定了类型该如何计算，同时也是一种约束，有了这种约束才能保证信息被正确处理。

#### 类型系统的作用

- 排查错误，编译或运行期间进行类型检查。
- 抽象，类型允许开发者站在更高的层面进行思考。
- 文档，明确的类型声明可以表明程序行为。
- 优化效率。
- 类型安全
  - 可以避免类型间的无效计算。
  - 保证内存安全。
  - 避免语义上的逻辑错误。

#### 类型系统的分类

在编译器进行类型检查的语言属于静态类型，在运行期间进行类型检查的语言属于动态类型。如果一门语言不允许类型的自动隐式转换，在强制转换前不同类型无法进行计算，则该语言属于强类型，反之则属于弱类型。

静态类型的语言能在编译期对代码进行静态分析，依靠的就是类型系统。Rust 在编译期间就能检测出数组是否越界访问，运行时抛出错误退出线程，不会因此去访问非法内存，所以 Rust 是类型安全的语言。

动态语言只能在运行时执行类型检查，但是当有数组越界时就回抛出异常退出线程，所以一些动态语言也是内存安全的。

#### 类型系统与多态性

如果一个类型系统允许一段代码在不同的上下文中有不同的类型，这样的类型系统就叫多态类型系统。
现代编程语言包含了三种多态形式：参数化多态（Parametric polymorphism）、Ad-hoc 多态（Ad-hoc polymorphism）、子类型多态（Subtype polymorphism）。如果按多态发生的时间来说又可以静多态（Static polymorphism）和动多态（Dynamic polymorphism）。静多态发生在编译期间，动多态发生在运行时。参数化多态和 Ad-hoc 多态一般时静多态，子类型多态一般是动多态。Rust 语言同时支持静多态和动多态。

参数多态化实际上就是指泛型。
Ad-hoc 多态 也叫特定多态。指同一种行为定义，在不同的上下文中会响应不同的行为实现。Rust 使用 trait 来支持 Ad-hoc 多态。
子类型多态一般用在面向对象语言中。Rust 不支持子类型多态。

### Rust 类型系统概述

Rust 是一种强类型且内存安全的语言。Rust 中一切皆表达式、表达式皆有值，值皆有类型。所以可以说，Rust 一切皆类型。

除了一些基本的原生类型和复合类型，Rust 把作用域也纳入了类型系统（生命周期标记）。

#### 类型大小

编程语言中不同类型本质上是内存占用空间和编码方式的不同，Rust 也不例外。Rust 中没有 GC，内存首先由编译器来分配，Rust 代码被编译为 LLVM IR，其中携带了内存分配的信息。所以编译器需要事先知道内存的大小，才能合理的分配内存。

可确定大小类型和动态类型。Rust 中绝大部分类型都是在编译器可确定大小的类型（Sized Type），比如原生整数类型 u32 固定是 4 个字节。u64 固定事 8 个字节等等，都是可以在编译期间确定大小的类型。然而 Rust 也有少量动态大小的类型（Dynamic Sized Typ， DST），比如 str 类型的字符串字面量，编译器不可能事先知道程序中会出现什么样的字符串，所以对于编译器来说 str 类型的字符串大小事无法确定的。对于这种情况 Rust 提供了引用类型，因为引用总会有固定且编译期已知的固定大小的类型，它由指针和长度信息组成。

&str 存储与栈上（包含指向字符串的指针和字符串长度） str 字符串序列存储与堆上。这种包含了动态大小类型地址信息和携带了长度信息的指针叫做胖指针（Fat Pointer）。